---
title: "Genfi First Pass"
author: "Tim Rittman"
date: "20/06/2015"
output: pdf_document
---

A first investigation of the GENFI data. The aim is to assess the connection strength of the data.

```{r,results='asis',echo=FALSE}
library(plyr)
library(ggplot2)
library(xtable)
library(car)

genfiDir = "/home/tim/GENFI/GENFI_camgrid_20150525/"
setwd(genfiDir)

inFile = "d2_degree_wt_local"
# import data
dF = read.table(inFile, header = TRUE, na.strings = "NA")

# convert diagnostic label to a factor and rename
dF$GS = as.factor(dF$GS)
dF$GS = revalue(dF$GS, c("0" = "gene negative", "1"="gene positive", "2"="affected"))

# Summarise the patient data
ptSum = ddply(dF, .(gene), summarise,
              "gene negative" = length(GS[GS=="gene negative"]),
              "gene positive" = length(GS[GS=="gene positive"]),
              "affected"      = length(GS[GS=="affected"])
              )

print(xtable(ptSum,
             caption="Subjects included in the analysis"),
      include.rownames=FALSE)

# set spike percentage threshold
spVal = 10  # would be better to define this using a Bayesian model averaging method
```
The spike percentage threshod is set at `r spVal`.

So that leaves us with the following subjects included:
```{r,results='asis',echo=FALSE}
library(xlsx)

# import file with spike percentage data
sp <- read.xlsx("../all_sm_thld10_SP.xlsx", sheetIndex = 1)
sp.sub <- data.frame(wbic=sp$id, spMean=sp$mean)
dF <- merge(dF, sp.sub, by="wbic")

dF <- dF[dF$spMean < spVal,]

# Summarise the patient data
ptSum = ddply(dF, .(gene), summarise,
              "gene negative" = length(GS[GS=="gene negative"]),
              "gene positive" = length(GS[GS=="gene positive"]),
              "affected"      = length(GS[GS=="affected"])
              )

print(xtable(ptSum,
             caption="Subjects included in the analysis"),
      include.rownames=FALSE)
```

As a first pass, I will examine the connection strength in each of these groups. Firstly, we'll look at the mean connection strength for the whole brain. In order to do this, we'll take the mean connection strength of each individual.

```{r,results='asis',echo=FALSE}
nodeNames = names(dF)[sapply(names(dF), function(x) grepl("X",x))]

# Take the mean values of 
dF.stacked = stack(dF[,nodeNames])
dF.stacked = data.frame(dF.stacked, GS=dF$GS, gene=dF$gene, wbic=dF$wbic)

dF.wb = ddply(dF.stacked, .(gene, wbic, GS), summarise,
              values = mean(values, na.rm = TRUE)
              )
```

Firstly we'll look at the results for the genes combined.

```{r,results='asis',echo=FALSE}
dF.wb.summary = ddply(dF.wb, .(), summarise,
                      "gene negative" = paste(round(mean(values[GS=="gene negative"], na.rm = TRUE), digits = 1),
                                              paste("(", round(sd(values[GS=="gene negative"], na.rm = TRUE), digits = 1),   ")", sep="")),
                      "gene positive" = paste(round(mean(values[GS=="gene positive"], na.rm = TRUE), digits = 1),
                                              paste("(", round(sd(values[GS=="gene positive"], na.rm = TRUE), digits = 1),   ")", sep="")),
                      "affected"      = paste(round(mean(values[GS=="affected"], na.rm = TRUE), digits = 1),
                                              paste("(", round(sd(values[GS=="affected"], na.rm = TRUE), digits = 1),   ")", sep=""))
                      )

print(xtable(dF.wb.summary[,-1],
             caption="Mean and standard deviations for connection strength values in individuals"),
      include.rownames=FALSE)

# # plot this
# err <- function(x) qnorm(0.975) * sd(x, na.rm = TRUE)/sqrt(length(x)) # function for standard error
# 
# dF.stacked.plot = ddply(dF.stacked, .(gene, GS), summarise, valuesMean=mean(values, na.rm = TRUE),
#                         upper = valuesMean+err(values),
#                         lower = valuesMean-err(values)
#                         )

# dF.stacked.plot <- data.frame(dF.stacked.plot, unique=seq(length(dF.stacked.plot[,1])))

# p <- ggplot(dF.stacked.plot, aes_string(x="unique", y="valuesMean", middle="valuesMean", group="unique", fill="gene", upper="upper", lower="lower"))

# ANOVA of the differences
mod <- lm(values~GS*gene)
mod.aov <- anova(mod)
print(xtable(mod.aov))

# now do a plot
p <- ggplot(dF.wb, aes_string(x="GS", y="values", fill="GS"))
p <- p + geom_boxplot()
p <- p + theme_bw()
p <- p + labs(y="Connection strength") + theme(axis.title.x=element_blank())
p
```

And now we'll look at individual genes.
```{r,results='asis',echo=FALSE}
dF.wb.summary = ddply(dF.wb, .(gene), summarise,
                      "gene negative" = paste(round(mean(values[GS=="gene negative"], na.rm = TRUE), digits = 1),
                                              paste("(", round(sd(values[GS=="gene negative"], na.rm = TRUE), digits = 1),   ")", sep="")),
                      "gene positive" = paste(round(mean(values[GS=="gene positive"], na.rm = TRUE), digits = 1),
                                              paste("(", round(sd(values[GS=="gene positive"], na.rm = TRUE), digits = 1),   ")", sep="")),
                      "affected"      = paste(round(mean(values[GS=="affected"], na.rm = TRUE), digits = 1),
                                              paste("(", round(sd(values[GS=="affected"], na.rm = TRUE), digits = 1),   ")", sep=""))
                      )

print(xtable(dF.wb.summary,
             caption="Mean and standard deviations for connection strength values in individuals"),
      include.rownames=FALSE)

# # plot this
# err <- function(x) qnorm(0.975) * sd(x, na.rm = TRUE)/sqrt(length(x)) # function for standard error
# 
# dF.stacked.plot = ddply(dF.stacked, .(gene, GS), summarise, valuesMean=mean(values, na.rm = TRUE),
#                         upper = valuesMean+err(values),
#                         lower = valuesMean-err(values)
#                         )

# dF.stacked.plot <- data.frame(dF.stacked.plot, unique=seq(length(dF.stacked.plot[,1])))

# p <- ggplot(dF.stacked.plot, aes_string(x="unique", y="valuesMean", middle="valuesMean", group="unique", fill="gene", upper="upper", lower="lower"))
p <- ggplot(dF.wb, aes_string(x="gene", y="values", fill="GS"))
p <- p + geom_boxplot()
p <- p + theme_bw()
p <- p + labs(y="Connection strength") + theme(axis.title.x=element_blank())
p
```

We'll plot the connection strengths against the time from average age at onset.

```{r, echo=FALSE, results='asis'}
genfiData <- read.table("../genfi_Subjects_sjones_1_22_2015_17_47_47_restructure_summary.csv",
                        sep="\t",
                        header = TRUE)

dF.aoo <- data.frame(wbic=genfiData$Subject,
                     aoo=genfiData$Yrs.from.AV_AAO)

dF <- merge(dF.wb, dF.aoo, by="wbic")
dF.plot <- dF[dF$GS!="gene negative",]

# correlation between average age at onset and connection strength
corac <- cor.test(dF.plot$aoo, dF.plot$values)
corac.affected <- cor.test(dF[dF$GS=="affected","aoo"],
                           dF[dF$GS=="affected","values"])

corac.carriers <- cor.test(dF[dF$GS=="gene positive","aoo"],
                           dF[dF$GS=="gene positive","values"])

```
The correlation coefficient between connection strength and average age at onset for affected and gene carriers is `r corac$statistic`, p=`r corac$p.value`.

For gene carriers the correlation coefficient is `r corac.carriers$statistic`, p=`r corac.carriers$p.value`

For affected subjects the correlation coefficient is `r corac.affected$statistic`, p=`r corac.affected$p.value`.


```{r,results='asis',echo=FALSE}
p <- ggplot(dF.plot, aes_string(x="aoo", y="values", colour="gene", shape="GS"))
p <- p + geom_point()
p

```
